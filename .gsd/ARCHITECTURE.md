# Architecture

> Auto-generated by /map on 2026-02-02

## Overview

The Subject Frame Extractor is a high-performance tool for extracting, analyzing, and filtering frames from videos. It utilizes state-of-the-art ML models (SAM3, InsightFace) to identify subjects (people) and calculate quality metrics, allowing for efficient dataset curation.

```
┌─────────────────────────────────────────┐
│              [app.py] (Entry)           │
├─────────────────────────────────────────┤
│            [ui/app_ui.py] (UI)          │
├──────────┬───────────┬──────────┬───────┤
│ [Source] │ [Subject] │ [Scenes] │ [Exp] │
├──────────┴───────────┴──────────┴───────┤
│         [ui/handlers/] (Events)         │
├─────────────────────────────────────────┤
│       [core/pipelines.py] (Logic)       │
├─────────────────────────────────────────┤
│ [Extraction] │ [Analysis] │ [Export]    │
├──────────┬───┴───────┬────┴──────┬──────┤
│ [FFmpeg] │ [SAM3/IF] │ [Filtering]      │
├──────────┴───────────┴──────────────────┤
│           [core/managers.py]            │
├──────────────────┬──────────────────────┤
│ [ModelRegistry]  │  [DatabaseManager]   │
└──────────────────┴──────────────────────┘
```

## Components

### 1. Main Entry & UI (`app.py`, `ui/`)
- **Purpose:** Assembler and interface.
- **Location:** `app.py`, `ui/app_ui.py`, `ui/tabs/`, `ui/handlers/`.
- **Details:** Uses Gradio to build a tabbed interface. Events are decoupled into `handlers/` which interact with `core/pipelines.py`.

### 2. Processing Pipelines (`core/pipelines.py`)
- **Purpose:** Orchestrates complex workflows.
- **Location:** `core/pipelines.py`.
- **Sub-pipelines:**
    - `ExtractionPipeline`: Handles FFmpeg-based frame/thumbnail extraction.
    - `AnalysisPipeline`: Coordinates subject tracking (SAM3) and metric calculation (InsightFace, NIQE, etc.).
    - `ExportPipeline`: Filters frames based on user criteria and packages them.

### 3. Model & Resource Managers (`core/managers.py`)
- **Purpose:** Lazy loading, thread-safety, and resource management.
- **Location:** `core/managers.py`.
- **Components:**
    - `ModelRegistry`: Manages heavy ML models (SAM3, Face models) with caching and GPU/CPU fallback.
    - `SAM3Wrapper`: High-level API for the SAM3 (Segment Anything Model 2/3) submodule.
    - `ThumbnailManager`: LRU cache for UI performance.

### 4. Data Layer (`core/database.py`, `core/config.py`)
- **Purpose:** Persistence and settings.
- **Location:** `core/database.py`, `core/config.py`.
- **Details:** SQLite database with JSON storage for extensible metrics. Pydantic-based configuration with `.env` and `config.json` support.

### 5. Utilities (`core/filtering.py`, `core/logger.py`)
- **Purpose:** Core algorithms and monitoring.
- **Logic:** `filtering.py` contains the math for quality scoring and frame de-duplication. `logger.py` provides structured JSONL logging.

## Data Flow

1. **Input**: User provides video/folder in the Source tab.
2. **Extraction**: `ExtractionPipeline` runs FFmpeg to generate thumbnails and low-res video for processing.
3. **Subject Selection**: User selects a seed (person/object) in the Subject tab.
4. **Propagation**: `AnalysisPipeline` tracks the subject across all frames using SAM3.
5. **Analysis**: Metrics (sharpness, face similarity, NIQE) are calculated for tracked frames.
6. **Filtering**: User sets thresholds in the UI; `filtering.py` applies these to the Database records.
7. **Export**: `ExportPipeline` copies/crops frames based on valid records.

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| FFmpeg | CLI | Frame extraction & downscaling |
| SAM3 (v3) | Library | Subject tracking & masking (Submodule) |
| InsightFace | Library | Face detection & embedding comparison |
| SQLite | Database | Metadata & metric persistence |
| Gradio | Framework | Web-based user interface |

## Technical Debt

- [ ] **Memory Management**: Incomplete implementation of memory monitoring and automatic cleanup (`core/config.py`).
- [ ] **Database Resilience**: Missing robust error recovery and retry logic in `_flush_buffer` (`core/database.py`).
- [ ] **Configuration**: SAM3 checkpoint URLs and SHA hashes are hardcoded or using placeholders (`core/config.py`).
- [ ] **Artifacts**: Presence of `ui/app_ui.py.bak` and manual scripts in `verification/`.
- [ ] **Submodule**: `SAM3_repo` status often requires manual verification of initialization.

## Conventions

- **Paths**: Always use `pathlib.Path`.
- **Imports**: Never import `ui/` inside `core/`. Use `core/shared.py` for cross-cutting concerns.
- **Concurrency**: `ThreadPoolExecutor` for IO-bound tasks; `threading.Event` for cancellation.
- **Typing**: Pydantic models for configuration and internal events.
- **Logging**: Structured JSONL for machine parsing + UI-friendly log stream.
