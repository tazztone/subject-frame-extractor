# Architecture

> Auto-generated by /map on 2026-02-06

## Overview

The Subject Frame Extractor is a high-performance tool for extracting, analyzing, and filtering frames from videos. It utilizes state-of-the-art ML models (SAM3, InsightFace) to identify subjects and an extensible **Operator Framework** to calculate quality metrics, allowing for efficient, plugin-based dataset curation.

```
┌─────────────────────────────────────────┐
│              [app.py] (Entry)           │
├─────────────────────────────────────────┤
│            [ui/app_ui.py] (UI)          │
│       (uses core/application_state.py)  │
├──────────┬───────────┬──────────┬───────┤
│ [Source] │ [Subject] │ [Scenes] │ [Exp] │
├──────────┴───────────┴──────────┴───────┤
│         [ui/handlers/] (Events)         │
├─────────────────────────────────────────┤
│       [core/pipelines.py] (Logic)       │
├────────────────────┬────────────────────┤
│    [Extraction]    │    [Analysis]      │
│      (FFmpeg)      │   (SAM3 + Ops)     │
├────────────────────┼────────────────────┤
│ [core/managers.py] │ [core/operators/]  │
│ (Models/Resources) │ (Metric Plugins)   │
└────────────────────┴────────────────────┘
          │                   │
          ▼                   ▼
  [core/database.py]   [core/params.py]
  (SQLite/Persistence) (Config/Schemas)
```

## Components

### 1. Main Entry & UI (`app.py`, `ui/`)
- **Purpose:** Assembler and interface.
- **Location:** `app.py`, `ui/app_ui.py`, `ui/tabs/`, `ui/handlers/`.
- **State Management:** `core/application_state.py` defines the unified `ApplicationState` used across the UI.
- **Details:** Uses Gradio to build a tabbed interface. Events are decoupled into `handlers/` which interact with `core/pipelines.py`.

### 2. Processing Pipelines (`core/pipelines.py`)
- **Purpose:** Orchestrates complex workflows.
- **Location:** `core/pipelines.py`.
- **Sub-pipelines:**
    - `ExtractionPipeline`: Handles FFmpeg-based frame/thumbnail extraction.
    - `AnalysisPipeline`: Coordinates subject tracking (SAM3) and delegates metric calculation to the **Operator Engine**.
    - `ExportPipeline`: Filters frames based on user criteria and packages them.

### 3. Operator Framework (`core/operators/`)
- **Purpose:** Extensible plugin system for image analysis metrics.
- **Location:** `core/operators/`.
- **Components:**
    - `OperatorRegistry`: Handles auto-discovery and registration of operators.
    - `Operator`: Protocol defining the interface for all analysis modules.
    - `run_operators`: Unified execution engine for running active operators on frames.

### 4. Model & Resource Managers (`core/managers.py`)
- **Purpose:** Lazy loading, thread-safety, and resource management.
- **Location:** `core/managers.py`.
- **Components:**
    - `ModelRegistry`: Manages heavy ML models (SAM3, Face models) with caching and GPU/CPU fallback.
    - `SAM3Wrapper`: High-level API for the SAM3 submodule.
    - `ThumbnailManager`: LRU cache for UI performance.

### 5. Data Layer (`core/database.py`, `core/config.py`)
- **Purpose:** Persistence and settings.
- **Location:** `core/database.py`, `core/config.py`, `core/application_state.py`.
- **Details:** SQLite database with JSON storage for extensible metrics. Pydantic-based configuration.

### 6. Utilities (`core/filtering.py`, `core/logger.py`, `core/fingerprint.py`)
- **Purpose:** Core algorithms, monitoring, and idempotency.
- **Logic:** `filtering.py` contains the math for quality scoring. `logger.py` provides structured logging. `core/fingerprint.py` implements the hashing logic for session caching.

## Data Flow

1. **Input**: User provides video/folder in the Source tab.
2. **Extraction**: `ExtractionPipeline` runs FFmpeg to generate thumbnails and low-res video.
3. **Subject Selection**: User selects a seed (person/object) in the Subject tab.
4. **Propagation**: `AnalysisPipeline` tracks the subject using SAM3.
5. **Operator Execution**: `AnalysisPipeline` invokes `run_operators`, which executes active operators (Sharpness, Face, NIQE, etc.) in parallel/sequence.
6. **Filtering**: User sets thresholds; `filtering.py` applies these to Database records.
7. **Export**: `ExportPipeline` copies/crops frames based on valid records.

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| FFmpeg | CLI | Frame extraction & downscaling |
| SAM3 (v3) | Library | Subject tracking & masking (Submodule) |
| InsightFace | Library | Face detection (via FacePoseOperator) |
| Operator Plugin| Internal | Metric calculation interface |
| SQLite | Database | Metadata & metric persistence |
| Gradio | Framework | Web-based user interface |

## Technical Debt

- [ ] **FFmpeg Optimization**: Support hardware acceleration (NVENC/VAAPI) and configurable audio codecs.
- [ ] **Extraction Resilience**: Add support for resumable extraction and parallel video decoding.
- [x] **Analysis Caching**: Skip already-analyzed extraction via fingerprinting.
- [ ] **Resume Propagation**: Formalize scene-level resumption for large-scale tracking.
- [ ] **Memory Management**: Automatic batch size adjustment based on available memory.
- [ ] **Error Recovery**: Implement per-frame error recovery in pipelines instead of skipping.
- [ ] **Submodule**: `SAM3_repo` initialization manual check.

## Conventions

- **Paths**: Always use `pathlib.Path`.
- **State**: Use `ApplicationState` for UI state data transfer.
- **Imports**: Never import `ui/` inside `core/`. Use `core/shared.py` (if exists) or dependency injection.
- **Concurrency**: `ThreadPoolExecutor` for IO-bound tasks.
- **Logging**: Structured JSONL.
